<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600,700">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.6.1/tachyons.min.css" integrity="sha256-eu1dpzpUytdOAUmB67Qi3mBb6HFjruP8BoAzk4lKiSc=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/css-spinning-spinners/1.1.1/load5.css"/>
    <style>
      .darken-10:hover,
      .darken-10:focus {
        box-shadow: inset 9999px 9999px rgba(0,0,0,0.10)
      }
      .darken-10:active {
        box-shadow: inset 9999px 9999px rgba(0,0,0,0.20)
      }
      
      .results {
        display: inline-block;
        width: 600px;
      }
    </style>
  </head>
  
  <body>

    <div id="top"></div>
    <div class="flex flex-column fixed absolute--fill overflow-hidden">
      <div class="flex-none flex flex-row items-center pa2">
        <div class="f4 dib ma0">Enter threshold</div>
          <form class="dib ml3">
            <input class="input-reset ba b--black-20 pa2 f6 w5" name="threshold" placeholder='"1000", etc' value="1000" onkeyup="this.value=this.value.replace(/[^0-9]/g,'');">
            <button type="button" class="btn-submit border-box no-select ba ttu b f6 ph3 pv2 br1 white bg-blue b--blue darken-10">Submit</button>
          </form>
      </div>
    </div>

    <br>

    <svg width="960" height="960" font-family="sans-serif" font-size="10" text-anchor="middle" id="svgid"></svg>
  
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    
    <script>
    
      // classes is a JS object that looks like this:
      // [{"id":"flare.analytics.cluster.AgglomerativeCluster","value":3938},
      //  {"id":"flare.analytics.cluster.CommunityStructure","value":3812},
      //  ...
      // ]

      function updateSvg(classes)
      {
        $("#svgid").empty();

        if (classes.length == 0)
          return;

        var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        var format = d3.format(",d");

        var color = d3.scaleOrdinal(d3.schemeCategory20c);

        var pack = d3.pack()
            .size([width, height])
            .padding(1.5);

        var root = d3.hierarchy({children: classes})
            .sum(function(d) { return d.value; })
            .each(function(d) {
              if (id = d.data.id) {
                var id, i = id.lastIndexOf(".");
                d.id = id;
                d.package = id.slice(0, i);
                d.class = id.slice(i + 1);
              }
            });
        var node = svg.selectAll(".node")
          .data(pack(root).leaves())
          .enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        node.append("circle")
            .attr("id", function(d) { return d.id; })
            .attr("r", function(d) { return d.r; })
            .style("fill", function(d) { return color(d.package); });
        node.append("clipPath")
            .attr("id", function(d) { return "clip-" + d.id; })
          .append("use")
            .attr("xlink:href", function(d) { return "#" + d.id; });
        node.append("text")
            .attr("clip-path", function(d) { return "url(#clip-" + d.id + ")"; })
          .selectAll("tspan")
          .data(function(d) { return d.class.split(/(?=[A-Z][^A-Z])/g); })
          .enter().append("tspan")
            .attr("x", 0)
            .attr("y", function(d, i, nodes) { return 13 + (i - nodes.length / 2 - 0.5) * 10; })
            .text(function(d) { return d; });
        node.append("title")
            .text(function(d) { return d.id + "\n" + format(d.value); });
      }
    
      $(function () {
        var doSubmit = function()
        {
          // disable submit button
          $('.btn-submit').addClass('o-40').text('Loading...').prop('disabled', 'true');
          $('#top').addClass('loading');
          $.ajax({
            type: 'post',
            url: 'https://www.flex.io/api/v1/pipes/flexio-wordcloud-v1/run?stream=0',
            beforeSend: function(xhr) {
              xhr.setRequestHeader('Authorization', 'Bearer nmgzsqppgwqbvkfhjdjd');
            },
            data: $('form').serialize(),
            dataType: "json",
            success: function (content) {
            
              updateSvg(content);

              // enable submit button
              $('.btn-submit').removeClass('o-40').text('Submit').removeAttr('disabled');
              $('#top').removeClass('loading');
            },
            error: function (xhr, status, error) {
              alert('post failed');
            }
          });
        }
        $('form').on('submit', function (evt) {
          evt.preventDefault();
          doSubmit();
        })
        $('.btn-submit').click(function(evt) {
          doSubmit();
        });
      });

    </script>
  
</body>
</html>
